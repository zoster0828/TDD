# 11장 뉴스 피드 시스템 설계
## 1단계 문제 이해 및 설계 범위 확정
* 포스팅 작성 가능, 친구의 포스팅 볼 수 있음
* 정렬은 시간의 역순
* 최대 5천명의 친구를 가질 수 있음
* DAU 천만
* 이미지, 비디오 등 미디어 파일 포함될 수 있음

## 2단계 개략적 설계안 제시 및 동의 구하기
### 피드 발행
* 새 포스트를 포스팅
* POST /v1/me/feed
  * restful하지 않은것 같음
  * /v1/userid/feed가 어떤지?
    * me라는 context를 사용한다고 생각하면 restful 한 느낌도 있음

* 사용자는 api를 사용해 포스팅를 올린다
* lb 통해 트래픽을 웹 서버로 분산하고
* 웹서버는 http요청을 여러 내부 서비스로 분산
* post service는 포스팅를 db와 cache에 저장한다
* fanout service는 새 포스팅를 친구의 뉴스 피드에 푸시한다
* noti는 친구들에게 새 포스팅가 올라왔음을 알린다

### 피드 읽기
* 뉴스 피드를 읽는다
* GET /v1/me/feed
  * POST와 비교했을때 feed의 의미가 좀 달라진것 같음
  * Get을 이렇게 쓴다면 POST는 /v1/me/feed/posting 가 되었어야 할 것 같음

* 사용자는 get api 이용해 피드를 읽는다
* lb는 트래픽을 웹 서버로 분산
* 웹 서버는 트래픽을 뉴스 피드 서비스로 보냄
* 뉴스 피드 서비스는 캐시에서 뉴스 피드를 가지고 옴
* 뉴스 피드 캐시는 뉴스 피드를 렌더링 할 때 필요한 피드의 id들을 보관

## 3단계 상세 설계
### 피드 발행 흐름 상세 설계
* 웹서버
  * 인증 / 처리율 제한
* fanout
  * 사용자의 포스팅을 사용자와 친구 관계에 있는 모든 사용자에게 전달
  * 쓰기 시점(push)
    * 기록되는 시점에 피드를 갱신
      * 실시간 갱신됨, 뉴스 피드 읽기의 latency 짧아짐
      * 친구가 많은 경우 많은 시간 소요될 수 있음
      * 자주 사용하지 않는 사용자의 피드도 갱신
  * 읽기 시점(pull)
    * 비활성화된 사용자는 트래픽 처리되지 않음
    * 뉴스 피드를 읽는데 많은 시간이 소요됨
* 두가지 방법을 결합하여 대부분의 사용자는 push, 친구가 많은 사용자의 경우 pull 모델 사용
1. 관계 db에서 친구 목록 가지고 옴
2. 사용자 정보 캐시에서 친구들의 정보를 가지고 옴
3. 친구 목록과 새 포스팅의 ID를 메시지 QUEUE에 삽입
4. 팬아웃 서버에서 데이터 꺼내어 뉴스피드 데이터를 캐시에 넣는다
   5. 전체를 저장하지 않는 것은 어떤 사용자가 올라온 포스팅 전체를 훑어볼 가능성이 매우 낮기 때문 캐시 미스를 고려하더라도 일부만 저장한다

### 피드 읽기 흐름 상세 설계
1. 사용자의 뉴스피드 읽기 요청
2. LB에서 웹서버로 요청
3. 웹서버에서 뉴스피드 서비스 호출
4. 뉴스피드 서비스는 캐시에서 포스팅 id 목록 가지고옴
5. 뉴스 피드에 표시할 사용자 이름, 사진 콘텐츠등을 가지고 완성
6. 생성된 피드를 클라이언트에 전송

### 캐시 구조
|        |        |     |
|--------|--------|-----|
| 뉴스 피드  | ---    | --- |
| 인기 컨텐츠 | 일반 컨텐츠 | --- |
| 팔로어    | 팔로잉    | --- |
| 좋아요    | 답글     | 기타  |
| 좋아요 횟수 | 답글 횟수  | 기타  |

## 4단계 마무리
* 언제나 정답은 없으며 어떤 trade-off 가 있었는지 잘 이해하고 설명할 수 있어야 함

---
상하차 스터디 토크
### 핫키 유저인지는 뭘로 구분할까?
* 어쩌면 instagram의 파란 딱지도 그런 개념이지 않을까?
* 별도의 테이블이 있어서 거기서 유저를 관리하고 있지 않을까?
* 주기적으로 metric 뽑아낸 것으로 구분하고 있을 것 같음