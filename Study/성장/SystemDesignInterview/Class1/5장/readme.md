# 5장. 안정 해시 설계

## 해시 키 재배치 문제
* 서버의 규모가 변한다면 해시키의 재배치는 불균형을 유발한다
* 캐시 미스가 대규모로 발생하게 된다

## 안정 해시
* 전통적 해시 테이블은 슬롯이 변하면 대부분 키를 재배치한다

### 해시 공간과 해시 링
* 해시를 loop시켜서 해시 링을 만든다
* 해시 링을 이용해 %연산을 사용하지 않고 다음 서버를 찾는다
  * linked list 개념
### 서버 추가
* 서버가 추가되더라도 키는 전부 재배치 될 필요 없다
* key는 다음 서버를 찾기 때문에 server 0 < > server 3 사이에 server 4가 추가 되더라도
  * server3.next는 server 0이 아닌 server4가 될 뿐이다

### 서버 제거
* 서버 제거도 동일하게 server0 < > server1 < > server 2 사이에 server1이 사라지더라도
* server0.next가 server2가 될뿐 전체 재배치를 하지 않는다

### 기본 구현법의 문제
* 키를 균등 분포 시키고 링을 탐색하다 만나는 첫 버거가 키가 저장될 서버가 된다
* 추가 또는 삭제시 키의 배포가 균등하지 않다
  * 예를 들어 두개 서버 사이에 server가 추가되면 각 서버는 n/2 개의 키를 가지고 그 사이에 또 서버가 추가되면 n/2/2개의 키를 가지게 된다

### 가상 노드
* 각 서버를 해시 링의 한곳에 배치하는 것이 아니라 분산해서 배치한다
* 가상 노드의 개수를 늘릴수록 키의 분포가 점점 균등해진다
* 그러나 가상 노드의 데이터를 저장해야 하는 공간이 점점 더 커지게 된다
  * 트레이드 오프를 감안해 적절한 갯수로 조정한다

### 재배치할 키 결정
* 어찌됐든 서버 추가나 제거시 일부는 재배치 되어야 함
* 반시계 방향에 있는 키들이 재배치 되게 된다

### 실제 사용
* 아마존의 DDB 파티셔닝
* 아파치 cassandra의 파티셔닝
* 디스코드
* 아카마이 CDN
* 매그레프의 네트워크 부하 분산기